import { NextRequest, NextResponse } from "next/server"

/**
 * Approximate US zip code prefix (first 3 digits) to lat/lng center.
 * Used as a lightweight client-side geocoding fallback.
 */
const ZIP_PREFIX_COORDS: Record<string, [number, number]> = {
  "010": [42.1, -72.6], "020": [42.4, -71.1], "021": [42.4, -71.1],
  "028": [41.8, -71.4], "030": [43.0, -71.5], "040": [43.7, -70.3],
  "050": [44.3, -72.6], "060": [41.8, -72.7], "070": [40.7, -74.2],
  "071": [40.7, -74.2], "072": [40.5, -74.4], "073": [40.5, -74.4],
  "074": [41.0, -74.3], "075": [40.9, -74.2], "076": [40.8, -74.1],
  "077": [40.3, -74.1], "078": [40.6, -74.6], "079": [40.9, -74.8],
  "080": [39.9, -75.0], "085": [40.2, -74.7],
  "100": [40.8, -74.0], "101": [40.8, -73.9], "102": [40.8, -73.9],
  "103": [40.6, -74.1], "104": [40.8, -73.9], "105": [41.0, -73.8],
  "110": [40.8, -73.7], "111": [40.7, -73.8], "112": [40.7, -74.0],
  "113": [40.7, -73.9], "114": [40.7, -73.8], "115": [40.8, -73.7],
  "116": [40.7, -73.8], "117": [40.7, -73.4], "118": [40.7, -73.4],
  "119": [40.8, -73.0], "120": [42.7, -73.7], "130": [43.1, -76.2],
  "140": [42.9, -78.9], "144": [43.2, -77.6], "150": [40.4, -80.0],
  "170": [40.3, -76.9], "172": [40.0, -76.3], "180": [40.6, -75.5],
  "190": [40.0, -75.1], "191": [40.0, -75.2],
  "200": [38.9, -77.0], "201": [38.9, -77.0], "202": [38.9, -77.0],
  "206": [38.9, -76.6], "209": [39.3, -76.6], "210": [39.3, -76.6],
  "211": [39.3, -76.6], "212": [39.3, -76.6],
  "220": [38.8, -77.1], "222": [38.8, -77.2], "223": [38.8, -77.4],
  "224": [37.6, -77.5], "230": [37.5, -77.4], "231": [36.8, -76.3],
  "240": [37.3, -79.9], "250": [38.3, -81.6],
  "270": [36.1, -80.2], "272": [35.8, -78.6], "277": [35.2, -80.8],
  "280": [35.2, -80.8], "290": [34.0, -81.0], "294": [32.8, -79.9],
  "300": [33.7, -84.4], "303": [33.7, -84.4], "311": [32.1, -81.1],
  "320": [30.3, -81.7], "321": [28.5, -81.4], "327": [28.5, -81.4],
  "330": [25.8, -80.2], "331": [25.8, -80.2], "333": [26.1, -80.1],
  "335": [27.9, -82.5], "337": [27.9, -82.5],
  "350": [33.5, -86.8], "360": [32.4, -86.3],
  "370": [36.2, -86.8], "375": [35.1, -90.0], "380": [35.1, -90.0],
  "390": [32.3, -90.2], "400": [38.3, -85.8], "403": [38.0, -84.5],
  "430": [40.0, -82.9], "440": [41.5, -81.7], "450": [39.1, -84.5],
  "460": [39.8, -86.1], "468": [41.7, -86.3], "480": [42.3, -83.0],
  "488": [42.7, -84.5], "490": [42.3, -85.6],
  "500": [41.6, -93.6], "530": [43.1, -89.4], "532": [43.0, -87.9],
  "550": [44.9, -93.3], "553": [44.9, -93.3], "570": [43.5, -96.7],
  "580": [46.9, -96.8],
  "600": [41.9, -87.6], "606": [41.9, -87.6], "610": [41.5, -90.6],
  "620": [39.8, -89.6], "630": [38.6, -90.2], "640": [39.1, -94.6],
  "660": [39.1, -94.6], "664": [39.0, -95.7], "670": [37.7, -97.3],
  "680": [41.3, -96.0], "700": [30.0, -90.1], "710": [32.5, -93.7],
  "717": [34.7, -92.3], "730": [35.5, -97.5], "740": [36.1, -95.9],
  "750": [32.8, -96.8], "760": [32.7, -97.3], "770": [29.8, -95.4],
  "780": [29.4, -98.5], "786": [30.3, -97.7], "790": [33.6, -101.8],
  "794": [31.8, -106.4],
  "800": [39.7, -105.0], "802": [39.7, -105.0], "808": [38.8, -104.8],
  "820": [41.1, -104.8], "832": [43.6, -116.2], "840": [40.8, -111.9],
  "850": [33.4, -112.0], "856": [32.2, -110.9], "870": [35.1, -106.6],
  "880": [32.3, -106.8], "889": [36.2, -115.1], "890": [36.2, -115.1],
  "893": [39.5, -119.8],
  "900": [34.1, -118.2], "906": [34.1, -118.2], "910": [34.0, -118.4],
  "919": [32.7, -117.2], "920": [32.7, -117.2], "925": [33.9, -117.4],
  "930": [34.4, -119.7], "936": [36.7, -119.8], "940": [37.8, -122.4],
  "941": [37.8, -122.4], "942": [38.6, -121.5], "943": [37.3, -121.9],
  "945": [37.8, -122.3], "950": [37.3, -121.9], "955": [40.6, -122.4],
  "956": [38.6, -121.5],
  "967": [21.3, -157.8], "968": [21.3, -157.8],
  "970": [45.5, -122.7], "971": [45.5, -122.7], "973": [44.9, -123.0],
  "977": [42.3, -122.9],
  "980": [47.6, -122.3], "981": [47.6, -122.3], "984": [47.3, -122.5],
  "989": [47.7, -117.4], "990": [47.7, -117.4],
  "995": [61.2, -149.9], "997": [64.8, -147.7],
}

/**
 * GET /api/geocode?zip=12345
 *
 * Convert a US zip code to approximate lat/lng coordinates.
 * Uses a prefix-based lookup table for fast, dependency-free geocoding.
 */
export async function GET(request: NextRequest) {
  const zip = request.nextUrl.searchParams.get("zip")

  if (!zip || zip.length < 3) {
    return NextResponse.json(
      { error: "Please provide a valid US zip code" },
      { status: 400 }
    )
  }

  const prefix = zip.substring(0, 3)
  const coords = ZIP_PREFIX_COORDS[prefix]

  if (!coords) {
    return NextResponse.json(
      { error: "Could not find coordinates for this zip code" },
      { status: 404 }
    )
  }

  return NextResponse.json({
    zip,
    latitude: coords[0],
    longitude: coords[1],
    approximate: true,
  })
}
